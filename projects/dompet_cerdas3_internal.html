<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Internal - Solusi Keuangan Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // Konfigurasi Supabase
        const SUPABASE_URL = 'https://weueopblwiliyjqaaqvb.supabase.co';
        const SUPABASE_KEY = 'YOUR_SUPABASE_PUBLIC_KEY'; // Ganti dengan key Anda
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Fungsi untuk mengirim magic link
        async function sendMagicLink(email) {
            try {
                const response = await fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/magic-link-auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        type: 'magic_link'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Cek email Anda untuk magic link!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Login Error:', error);
                alert('Gagal mengirim magic link: ' + error.message);
            }
        }

        // Fungsi logout menggunakan Supabase
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error.message);
            }
            updateAuthUI();
        }

        // Fungsi untuk mendapatkan profil pengguna
        async function getUserProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return null;
            
            try {
                const response = await fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/profile-management', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabase.auth.getSession().then(s => s.access_token)}`
                    },
                    body: JSON.stringify({
                        action: 'get_profile'
                    })
                });

                const profile = await response.json();
                return profile;
            } catch (error) {
                console.error('Error getting profile:', error);
                return null;
            }
        }

        // Fungsi update UI autentikasi
        async function updateAuthUI() {
            const { data: { user } } = await supabase.auth.getUser();
            const authScreen = document.getElementById('authScreen');
            const appContainer = document.getElementById('appContainer');
            
            if (user) {
                authScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                
                // Dapatkan profil pengguna
                const profile = await getUserProfile();
                
                // Update UI dengan data profil
                if (profile) {
                    document.getElementById('user-email').textContent = profile.email || user.email;
                    document.getElementById('user-name').textContent = profile.full_name || 'Pengguna Dompet';
                    
                    // Update saldo jika ada
                    if (profile.balance) {
                        document.getElementById('balanceAmount').textContent = `Rp ${profile.balance.toLocaleString('id-ID')}`;
                    }
                    
                    // Update foto profil jika ada
                    if (profile.avatar_url) {
                        document.querySelector('.user-info img').src = profile.avatar_url;
                    }
                }
            } else {
                authScreen.style.display = 'block';
                appContainer.style.display = 'none';
            }
        }

        // Listener untuk perubahan status autentikasi
        supabase.auth.onAuthStateChange((event, session) => {
            updateAuthUI();
        });

        // Inisialisasi event listener saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            // Login dengan magic link
            document.getElementById('btnMagicLink').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                if (email) {
                    await sendMagicLink(email);
                } else {
                    alert('Masukkan email terlebih dahulu');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Update UI awal
            updateAuthUI();
            
            // Fungsi transfer dengan integrasi Supabase
            window.processTransfer = async function() {
                const recipientEmail = document.getElementById('recipientEmail').value;
                const amount = parseInt(document.getElementById('transferAmount').value);
                const note = document.getElementById('transferNote').value;
                
                if (!recipientEmail || !amount || amount <= 0) {
                    alert('Mohon isi semua data dengan benar!');
                    return;
                }
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('User not authenticated');
                    
                    // Panggil fungsi transfer di Edge Function
                    const response = await fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/transfer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${supabase.auth.getSession().then(s => s.access_token)}`
                        },
                        body: JSON.stringify({
                            recipient_email: recipientEmail,
                            amount: amount,
                            note: note
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`Transfer Rp${amount.toLocaleString('id-ID')} berhasil!`);
                        closeModal('transferModal');
                        updateAuthUI(); // Refresh UI
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Transfer error:', error);
                    alert('Transfer gagal: ' + error.message);
                }
            };
            
            // Fungsi top up dengan integrasi Supabase
            window.processTopup = async function() {
                const amount = parseInt(document.getElementById('topupAmount').value);
                const method = document.getElementById('paymentMethod').value;
                
                if (!amount || amount <= 0 || !method) {
                    alert('Mohon isi semua data dengan benar!');
                    return;
                }
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('User not authenticated');
                    
                    // Panggil fungsi top up di Edge Function
                    const response = await fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/topup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${supabase.auth.getSession().then(s => s.access_token)}`
                        },
                        body: JSON.stringify({
                            amount: amount,
                            method: method
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`Top up Rp${amount.toLocaleString('id-ID')} berhasil!`);
                        closeModal('topupModal');
                        updateAuthUI(); // Refresh UI
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Topup error:', error);
                    alert('Top up gagal: ' + error.message);
                }
            };
        });
    </script>
    <style>
        /* CSS yang sama seperti sebelumnya */
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-header">
            <h2><i class="fas fa-wallet"></i> Dompet Internal</h2>
            <p>Solusi keuangan digital untuk kebutuhan internal</p>
        </div>
        <div class="auth-body">
            <div id="loginForm">
                <h3 class="form-title">Masuk dengan Magic Link</h3>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="email@contoh.com">
                </div>
                <button class="btn btn-primary" style="width:100%;" id="btnMagicLink">
                    <i class="fas fa-paper-plane"></i> Kirim Magic Link
                </button>
            </div>
        </div>
        <div class="auth-footer">
            <div id="loginFooter">
                Dengan masuk, Anda menyetujui <a href="#">Syarat & Ketentuan</a>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appContainer" class="container" style="display:none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <h1>Dompet Internal</h1>
            </div>
            
            <div class="menu">
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-page="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transaksi</span>
                </div>
                <div class="menu-item" data-page="transfer">
                    <i class="fas fa-paper-plane"></i>
                    <span>Transfer</span>
                </div>
                <div class="menu-item" data-page="topup">
                    <i class="fas fa-coins"></i>
                    <span>Top Up</span>
                </div>
                <div class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </div>
            </div>
            
            <div class="logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari transaksi, pengguna...">
                </div>
                
                <div class="user-info">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" id="user-avatar">
                    <div class="user-details">
                        <div class="name" id="user-name">Pengguna Dompet</div>
                        <div class="role" id="user-email">user@contoh.com</div>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-content">
                    <div class="section-title">
                        <h2>Dashboard</h2>
                        <button class="btn btn-primary" onclick="openModal('topupModal')">
                            <i class="fas fa-plus"></i> Top Up
                        </button>
                    </div>
                    
                    <div class="card-container">
                        <!-- Balance Card -->
                        <div class="card balance-card">
                            <div class="balance-title">
                                <i class="fas fa-wallet"></i>
                                <span>Saldo Dompet</span>
                            </div>
                            <div class="balance-amount" id="balanceAmount">Rp 0</div>
                            <div class="balance-actions">
                                <button class="btn btn-light" onclick="openModal('transferModal')">
                                    <i class="fas fa-paper-plane"></i> Transfer
                                </button>
                                <button class="btn btn-light" onclick="openModal('topupModal')">
                                    <i class="fas fa-plus"></i> Top Up
                                </button>
                            </div>
                        </div>
                        
                        <!-- ... (bagian lainnya tetap sama) ... -->
                    </div>
                </div>
                
                <!-- Pengaturan Profil -->
                <div id="settingsPage" class="page-content" style="display:none;">
                    <div class="section-title">
                        <h2>Pengaturan Profil</h2>
                    </div>
                    
                    <div class="card">
                        <h3>Informasi Pribadi</h3>
                        <div class="form-group">
                            <label>Nama Lengkap</label>
                            <input type="text" id="profileName" placeholder="Nama lengkap">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail" placeholder="Email" disabled>
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="profileBio" placeholder="Deskripsi singkat tentang Anda" rows="3"></textarea>
                        </div>
                        
                        <h3>Keamanan</h3>
                        <div class="form-group">
                            <label>Password Baru</label>
                            <input type="password" id="newPassword" placeholder="Password baru">
                        </div>
                        <div class="form-group">
                            <label>Konfirmasi Password</label>
                            <input type="password" id="confirmPassword" placeholder="Konfirmasi password">
                        </div>
                        
                        <button class="btn btn-primary" onclick="updateProfile()">
                            <i class="fas fa-save"></i> Simpan Perubahan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ... (modal transfer dan top up) ... -->
    
    <script>
        // Fungsi untuk mengupdate profil
        async function updateProfile() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const name = document.getElementById('profileName').value;
                const bio = document.getElementById('profileBio').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validasi password
                if (newPassword && newPassword !== confirmPassword) {
                    throw new Error('Password tidak cocok');
                }
                
                // Update profile di Edge Function
                const response = await fetch('https://weueopblwiliyjqaaqvb.supabase.co/functions/v1/profile-management', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabase.auth.getSession().then(s => s.access_token)}`
                    },
                    body: JSON.stringify({
                        action: 'update_profile',
                        data: {
                            full_name: name,
                            bio: bio
                        }
                    })
                });
                
                const result = await response.json();
                
                // Update password jika diisi
                if (newPassword) {
                    const { error } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                }
                
                alert('Profil berhasil diperbarui!');
                updateAuthUI();
            } catch (error) {
                console.error('Update profile error:', error);
                alert('Gagal memperbarui profil: ' + error.message);
            }
        }
        
        // Fungsi untuk modal (sama seperti sebelumnya)
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    </script>
</body>
</html>